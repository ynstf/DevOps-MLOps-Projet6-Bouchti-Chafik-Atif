<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Dashboard</title>
    <style>
        /* ---------- GLOBAL ---------- */
        * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        }

        body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: #f4f6f8;
        color: #2c3e50;
        padding: 20px;
        }

        .container {
        max-width: 1400px;
        margin: auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        overflow: hidden;
        }

        /* ---------- HEADER ---------- */
        .header {
        background: #1f3a5f;
        color: white;
        padding: 30px;
        }

        .header h1 {
        font-size: 2em;
        margin-bottom: 5px;
        }

        .header p {
        font-size: 0.95em;
        opacity: 0.85;
        }

        /* ---------- UPLOAD ---------- */
        .upload-section {
        padding: 40px;
        text-align: center;
        }

        .upload-box {
        border: 2px dashed #3a7bd5;
        border-radius: 12px;
        padding: 50px;
        background: #fafbfc;
        cursor: pointer;
        }

        .upload-box:hover {
        background: #eef2f7;
        }

        .upload-icon {
        font-size: 3em;
        margin-bottom: 15px;
        color: #3a7bd5;
        }

        input[type="file"] {
        display: none;
        }

        .btn {
        background: #3a7bd5;
        color: white;
        border: none;
        padding: 12px 28px;
        font-size: 1em;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        }

        .btn:hover {
        background: #2f66b3;
        }

        /* ---------- LOADING ---------- */
        .loading {
        display: none;
        text-align: center;
        padding: 50px;
        }

        .spinner {
        border: 4px solid #eaeaea;
        border-top: 4px solid #3a7bd5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: auto;
        }

        @keyframes spin {
        to { transform: rotate(360deg); }
        }

        /* ---------- RESULTS ---------- */
        .results-section {
        display: none;
        padding: 40px;
        }

        .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
        gap: 20px;
        margin-bottom: 30px;
        }

        .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border-left: 6px solid;
        }

        .stat-card.total { border-color: #3a7bd5; }
        .stat-card.fraud { border-color: #e74c3c; }
        .stat-card.legit { border-color: #2ecc71; }

        .stat-label {
        font-size: 0.9em;
        opacity: 0.7;
        }

        .stat-number {
        font-size: 2.2em;
        font-weight: 600;
        margin: 8px 0;
        }

        /* ---------- TABLE ---------- */
        .table-container {
        margin-top: 30px;
        overflow-x: auto;
        }

        table {
        width: 100%;
        border-collapse: collapse;
        }

        th {
        background: #1f3a5f;
        color: white;
        padding: 14px;
        text-align: left;
        }

        td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        }

        tr:hover {
        background: #f6f8fb;
        }

        .badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 0.85em;
        }

        .badge.fraud {
        background: #e74c3c;
        color: white;
        }

        .badge.legit {
        background: #2ecc71;
        color: white;
        }

        .probability-bar {
        height: 8px;
        background: #eaeaea;
        border-radius: 4px;
        overflow: hidden;
        }

        .probability-fill {
        height: 100%;
        background: linear-gradient(90deg, #2ecc71, #e74c3c);
        }

        /* ---------- FOOTER ACTIONS ---------- */
        .download-section {
        margin-top: 20px;
        text-align: center;
        }

        .error {
        display: none;
        background: #fdecea;
        color: #c0392b;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fraud Detection System</h1>
            <p>Upload your CSV file to analyze transactions</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">üìÅ</div>
                <h2>Drop your CSV file here</h2>
                <p style="margin: 20px 0; color: #6c757d;">or</p>
                <label for="fileInput" class="btn">Choose File</label>
                <input type="file" id="fileInput" accept=".csv">
                <p style="margin-top: 20px; color: #6c757d; font-size: 0.9em;">
                    CSV must contain: Time, Amount, V1-V28
                </p>
            </div>
            <div class="error" id="errorMsg"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Analyzing transactions...</h3>
            <p>This may take a few moments</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="margin-bottom: 30px; color: #667eea;">Analysis Results</h2>
            
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
                <div class="stat-card fraud">
                    <div class="stat-label">Fraudulent</div>
                    <div class="stat-number" id="fraudCount">0</div>
                    <div class="stat-label" id="fraudPercent">0%</div>
                </div>
                <div class="stat-card legit">
                    <div class="stat-label">Legitimate</div>
                    <div class="stat-number" id="legitCount">0</div>
                    <div class="stat-label" id="legitPercent">0%</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="chartCanvas" width="800" height="300"></canvas>
            </div>

            <div class="download-section">
                <button class="btn" onclick="downloadResults()">üíæ Download Results (CSV)</button>
                <button class="btn" onclick="resetUpload()">üîÑ Analyze Another File</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Probability</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let resultsData = [];
        const API_URL = 'http://localhost:9000';

        // Drag & Drop
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadBox.addEventListener(eventName, () => {
                uploadBox.classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, () => {
                uploadBox.classList.remove('dragover');
            });
        });

        uploadBox.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            if (!file.name.endsWith('.csv')) {
                showError('Please upload a CSV file');
                return;
            }

            // Show loading
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const text = await file.text();
                const transactions = parseCSV(text);
                await analyzeTransactions(transactions);
            } catch (error) {
                showError('Error processing file: ' + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const transactions = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const transaction = {};
                headers.forEach((header, index) => {
                    transaction[header] = parseFloat(values[index]);
                });
                transactions.push(transaction);
            }
            
            return transactions;
        }

        async function analyzeTransactions(transactions) {
            resultsData = [];
            let fraudCount = 0;
            let legitCount = 0;

            for (let i = 0; i < transactions.length; i++) {
                try {
                    const response = await fetch(`${API_URL}/predict`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(transactions[i])
                    });

                    const result = await response.json();
                    
                    resultsData.push({
                        index: i + 1,
                        amount: transactions[i].Amount,
                        is_fraud: result.is_fraud,
                        probability: result.probability,
                        risk_level: result.risk_level
                    });

                    if (result.is_fraud) fraudCount++;
                    else legitCount++;

                } catch (error) {
                    console.error('Error analyzing transaction', i, error);
                }
            }

            displayResults(fraudCount, legitCount);
        }

        function displayResults(fraudCount, legitCount) {
            const total = fraudCount + legitCount;
            const fraudPercent = ((fraudCount / total) * 100).toFixed(1);
            const legitPercent = ((legitCount / total) * 100).toFixed(1);

            document.getElementById('totalCount').textContent = total;
            document.getElementById('fraudCount').textContent = fraudCount;
            document.getElementById('legitCount').textContent = legitCount;
            document.getElementById('fraudPercent').textContent = `${fraudPercent}%`;
            document.getElementById('legitPercent').textContent = `${legitPercent}%`;

            // Draw chart
            drawChart(fraudCount, legitCount);

            // Fill table
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';

            resultsData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.index}</td>
                    <td>$${row.amount.toFixed(2)}</td>
                    <td><span class="badge ${row.is_fraud ? 'fraud' : 'legit'}">
                        ${row.is_fraud ? 'FRAUD' : 'LEGIT'}
                    </span></td>
                    <td>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: ${row.probability * 100}%"></div>
                        </div>
                        ${(row.probability * 100).toFixed(1)}%
                    </td>
                    <td>${row.risk_level}</td>
                `;
                tbody.appendChild(tr);
            });

            // Show results
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
        }

        function getConfidenceEmoji(prob) {
            if (prob > 0.8 || prob < 0.2) return 'üéØ High';
            if (prob > 0.6 || prob < 0.4) return 'üëç Medium';
            return '‚ö†Ô∏è Low';
        }

        function drawChart(fraudCount, legitCount) {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const total = fraudCount + legitCount;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bars
            const barWidth = 200;
            const maxHeight = 250;
            
            const fraudHeight = (fraudCount / total) * maxHeight;
            const legitHeight = (legitCount / total) * maxHeight;

            // Fraud bar
            const gradient1 = ctx.createLinearGradient(0, 0, 0, maxHeight);
            gradient1.addColorStop(0, '#f093fb');
            gradient1.addColorStop(1, '#f5576c');
            ctx.fillStyle = gradient1;
            ctx.fillRect(150, maxHeight - fraudHeight + 20, barWidth, fraudHeight);

            // Legit bar
            const gradient2 = ctx.createLinearGradient(0, 0, 0, maxHeight);
            gradient2.addColorStop(0, '#4facfe');
            gradient2.addColorStop(1, '#00f2fe');
            ctx.fillStyle = gradient2;
            ctx.fillRect(450, maxHeight - legitHeight + 20, barWidth, legitHeight);

            // Labels
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Fraud (${fraudCount})`, 250, maxHeight + 50);
            ctx.fillText(`Legit (${legitCount})`, 550, maxHeight + 50);
        }

        function downloadResults() {
            const csv = [
                ['Index', 'Amount', 'Is Fraud', 'Probability', 'Risk Level'],
                ...resultsData.map(r => [
                    r.index,
                    r.amount.toFixed(2),
                    r.is_fraud ? 'FRAUD' : 'LEGIT',
                    (r.probability * 100).toFixed(2) + '%',
                    r.risk_level
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fraud_detection_results_${Date.now()}.csv`;
            a.click();
        }

        function resetUpload() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('fileInput').value = '';
            resultsData = [];
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>